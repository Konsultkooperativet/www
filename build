set -x

cd cv

npm install -g resume-cli
npm install -g handlebars
npm install -g moment
npm install -g uncss

npm install -g ./jsonresume-theme-konsultcoop

for f in consultants/*.json; 
do 
	echo "Processing $f file.."; 

	NAME=`echo "$f" | cut -d'.' -f1`
	NAME=`echo "$NAME" | cut -d'/' -f2`

	cp $f resume.json
	resume export --theme konsultcoop $NAME.html
	cp $NAME.html ../public/cv/$NAME.html
done
cd ..

COMMON_CSS=`cat css/common.html`

cd public

for i in $(find . -name '*.html'); do # This breaks if filenames have whitespaces!
	echo "Parsing CSS for $i\n"
	sed "s?<\!---CSS-->?$COMMON_CSS?g" $i > $i.html
	uncss $i.html > $i.html.css
	NEW_CSS=`cat $i.html.css`
	sed "s?\<\!---CSS-->?$NEW_CSS?g" $i > $i.html
	rm $i.html.css
	rm $i
	mv $i.html $i
done