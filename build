#!/bin/sh
set -x

cd cv

npm install -g resume-cli
npm install -g handlebars
npm install -g moment
npm install -g critical

npm install -g ./jsonresume-theme-konsultcoop

for f in consultants/*.json; 
do 
	echo "Processing $f file.."; 

	NAME=`echo "$f" | cut -d'.' -f1`
	NAME=`echo "$NAME" | cut -d'/' -f2`

	cp $f resume.json
	resume export --theme konsultcoop $NAME.html
	cp $NAME.html ../public/cv/$NAME.html
done
cd ..

cd public

echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\"
  xmlns:xhtml=\"http://www.w3.org/1999/xhtml\">
" > sitemap.xml;

for i in $(find . -name '*.html'); do # This breaks if filenames have whitespaces!
	echo "Generating Sitemap for $i\n"

	NAME=`echo "$i" | cut -d'.' -f1`
	
	if [ "$NAME" == "index"]
	then
		$NAME = "";
	fi

	echo "
 <url>
    <loc>https://konsult.coop/$NAME</loc>
    <xhtml:link 
                 rel=\"alternate\"
                 hreflang=\"en\"
                 href=\"https://konsult.coop/en/$NAME\"
                 />
    <xhtml:link 
                 rel=\"alternate\"
                 hreflang=\"sv\"
                 href=\"https://konsult.coop/$NAME\"
                 />
</url>" >> sitemap.xml;
done
echo "</urlset>
" >> sitemap.xml;

#npm install -g sitemap-static

#sitemap-static --pretty --prefix=https://konsult.coop/ . > sitemap.xml


cd ..

npm install -g static-i18n
static-i18n -l sv -i sv -i en public

mv i18n/*.html public/
mv i18n/en public/

cd public

for i in $(find . -name '*.html'); do # This breaks if filenames have whitespaces!
	echo "Parsing CSS for $i\n"

	cat $i | critical --minify true --base ./ --inline > $i.crit	
	
	rm $i
	mv $i.crit $i
done




